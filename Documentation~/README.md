# Overview

The Athlos Unity Webview SDK helps connect your Unity project to Athlos via an embedded webview.

# Package Contents

- Runtime
  - **Athlos.cs**<br>A singleton behaviour that provides application wide access to Athlos, handling tenants and 
authentication.
  - **AthlosWebView.cs**<br>Base abstract class for all webview implementations. You can either use one of the already 
provided implementations for the more popular webviews or extend this behaviour to implement your own.  
  - **Environment.cs**<br>Enum to help determine which environment of your tenant to address

# Installation Instructions

1. Within Unity open `Window` &rarr; `Package Manager`
2. Click the `+` button in the Package Manager and select `Git Url`
3. Enter the following URL: `https://bitbucket.org/athlosgg/athlos-unity-webview.git`
4. Click `Import`
The package will install itself into your Packages folder under Gritstone Games Ltd.

# Requirements

This package is compatible with Unity 2022.3 and later. Other versions may function but are not tested.

# Workflows

There are 3 typical steps in using this package:
1. Set up the Athlos Tenant and Environment
2. Implement authentication with Athlos
3. Implement an Athlos compatible webview

## Set up the Athlos Tenant and Environment

1. In your opening scene create an empty game object - we suggest calling it `Athlos`.
2. Add the Athlos component to this game object.
3. Enter your tenant base name in the `tenant` field
4. Select the appropriate sub-tenant you want the Athlos client to connect to.<br>
If you want to target an additional sub tenant to Development and Production, select `Custom` and enter the full tenant name in the above `tenant` field.

## Implement authentication with Athlos

Athlos requires clients to authenticate themselves via a player's JSON Web Token (JWT). First we need to instruct Athlos 
as to how we obtain a player's JWT and then we instruct Athlos to acquire it when appropriate.

### Set Authentication Method

JWTs are typically generated by your server after successful player authentication. This is beyond the scope of this 
package but you can find more information [here](https://athlos.readme.io/docs/creating-jwts-for-user-authentication).

In your code you need to determine how Athlos authenticates your player - this is done by calling `Athlos.SetAuthentcationMethod`

    public delegate Task<string> AthlosAuthenticate();
    
    public static void SetAuthenticationMethod(AthlosAuthenticate authMethod)

You must pass a delegate that returns an asynchronous task that in turn returns a string containing the JWT for the player.

In this example we will use Athlos REST API to login a player with their e-mail address and password directly from the client.

> **Note:** This is not the recommended way to authenticate a user; it is merely used for demonstration purposes. You would
> instead return a JWT from your own REST API or server function.
```c#
[Serializable]
struct LoginBody //Stub POST body for login via email and password
{
  public string email;
  public string password; 
}

[Serializable]
struct LoginResponseData //Stub response body for authenticated player
{
  public string token; //The JWT for the authenticated player
}

[Serializable]
struct LoginResponse //Object returned via JSON response
{
  public LoginResponseData data;
  public object[] meta;
}

private TaskCompletionSource<string> _fetchJwt;
    
private void Start()
{
  //Determine *how* Athlos acquires the JWT for the player
  Athlos.Athlos.SetAuthenticationMethod(AuthenticateAthlos); 
}
    
private Task<string> AuthenticateAthlos()
{
  _fetchJwt = new TaskCompletionSource<string>();
  StartCoroutine(LoginIntoAthlos());
  return _fetchJwt.Task;
}

// Authenticate the player with an e-mail address and password. 
// Return the generated JWT to Athlos
private IEnumerator LoginIntoAthlos()
{
  string uri = "https://api.athlos.gg/api/users/1.0/login";
  using (UnityWebRequest request = new UnityWebRequest(uri, UnityWebRequest.kHttpVerbPOST))
  {
    request.SetRequestHeader("X-Origin", Athlos.Athlos.Tenant);
    request.SetRequestHeader("Content-Type", "application/json");
    LoginBody body = new LoginBody()
    {
      email = "example@example.com",
      password = "pa55word"
    };
    byte[] bodyRaw = System.Text.Encoding.UTF8.GetBytes(JsonConvert.SerializeObject(body));
    request.uploadHandler = new UploadHandlerRaw(bodyRaw);
    request.downloadHandler = new DownloadHandlerBuffer();
    yield return request.SendWebRequest();
    if (request.result == UnityWebRequest.Result.Success)
    {
      string responseJson = request.downloadHandler.text;
      LoginResponse response = JsonConvert.DeserializeObject<LoginResponse>(responseJson);
      _fetchJwt.SetResult(response.data.token);
    }
    else
    {
      Debug.LogError(request.error);
      _fetchJwt.SetResult("");
    }
  }
}
```

### Authenticate

Once you have determined how Athlos acquires the player's JWT you can authenticate the player when appropriate by calling `Authenticate()`.
By using `Authenticated` property you can determine when the player is actually authenticated before proceeding with other aspects of your game.

```c#
private IEnumerator AuthenticateWithAthlos(Action onAuthenticated)
{
  //Authenticate the player with your desired authenication process 
  Athlos.Athlos.Authenticate(); 
  //Wait until the player is authenticated with Athlos by acquiring their JWT
  yield return new WaitUntil(() => Athlos.Athlos.Authenticated);
  //Continue knowing you have authenticated the player
  onAuthenticated();
}
```

## Implement an Athlos compatible webview

To use Athlos with an embedded webview in your game we must inject the sync function using the JWT we have for the player.
By using a supported webview all that is needed is to add a respective Athlos webview component alongside your webview component
in your scene. The webview will then automatically point to the correct URL when the scene is loaded.

You can import an officially supported webview component using the Samples in the package. Currently supported webviews are:

- [Gree](https://github.com/gree/unity-webview)
- [Vuplex](https://developer.vuplex.com/webview/overview)

If you think there is a popular webview that isn't supported please contact us. You can also implement your own webview by following the information below.

# Advanced Topics

## Creating your own Athlos compatible webview

Implementing your own Athlos Webview component is simply a case of deriving from `AthlosWebView`. When doing so you must 
set the initial address to `InitialURL` and using whatever means available to pass the `AuthenticationScript` as a script 
when the webview starts. Below is an example of how we implement it for a Vuplex webview:
> **Note:** you should use the officially supported Vuplex component in reality

```c#
[RequireComponent(typeof(BaseWebViewPrefab))]
public class AthlosVuplexWebView : AthlosWebView
{
  private BaseWebViewPrefab _vuplexWebView;
  
  private void Awake()
  {
    _vuplexWebView = GetComponent<BaseWebViewPrefab>();
    _vuplexWebView.Initialized += OnVuplexWebViewInitialized;
    _vuplexWebView.InitialUrl = InitialURL;
  }

  private void OnVuplexWebViewInitialized(object sender, EventArgs e)
  {
    _vuplexWebView.Initialized -= OnVuplexWebViewInitialized;
    _vuplexWebView.WebView.PageLoadScripts.Add(AuthenticationScript);
  }
}
```

# Samples

The samples provided are actually the official supported Athlos WebView components that integrates with popular embedded 
webview solutions. Simply import one of the following samples and integrate into your scene alongside your chosen webview.

- **Gree** `AthlosGreeWebView.cs`
- **Vuplex** `AthlosVuplexWebView.cs`